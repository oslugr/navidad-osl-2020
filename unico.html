<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSL - Felicitación navidad</title>

    <!-- Semantic UI -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

    <style>
        html, body{
    margin: 0;
    padding: 0;
    width: 100%;
}

#main{
    width: 100%;
    margin: 0;
}

#resultado{
    padding: 0;
    width: 100%;
}

#contenido{
    margin: 0;
}

#boton-sup{
    border-radius: 0;
}

#warning{
    /* Para que no se solape con el botón superior*/
    margin: 0;
}

/*
    SLIDER
*/

#slider-div{
    padding-bottom: 20px;
    /* height: 100%; */
}

#slider{
    width: 100%;
    -webkit-appearance: none;  /* Override default CSS styles */
    appearance: none;
    height: 7px; /* Specified height */
    background: #cacbcd; /* Grey background */
    outline: none; /* Remove outline */
    opacity: 1; /* Set transparency (for mouse-over effects on hover) */
    -webkit-transition: .2s; /* 0.2 seconds transition on hover */
    transition: opacity .2s;
    border-radius: 2px;
}

#slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%; 
    background: rgba(0,0,0);
    cursor: pointer;
}

#slider::-moz-range-thumb {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: rgb(43, 43, 43);
    cursor: pointer;
}

.sticker-img{
    width: 100%;
}

#multi-item-example{
    overflow: hidden;
}

.carousel-control-prev{
    background-color: black;
    opacity: 30%;
}

.carousel-control-prev-icon {
    background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%236c757d' viewBox='0 0 8 8'%3E%3Cpath d='M5.25 0l-4 4 4 4 1.5-1.5-2.5-2.5 2.5-2.5-1.5-1.5z'/%3E%3C/svg%3E") !important;
}

.carousel-control-next-icon {
    background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%236c757d' viewBox='0 0 8 8'%3E%3Cpath d='M2.75 0l-1.5 1.5 2.5 2.5-2.5 2.5 1.5 1.5 4-4-4-4z'/%3E%3C/svg%3E") !important;
}

.slider-control{
    display: flex;
    justify-content: center;
    align-items: center;
}

.sticker-click:hover{
    cursor: pointer;
}
    </style>
</head>

<body>
        
        <!-- División en dos columnas -->
        <div id="main" class="ui two column doubling grid">

            <!-- Zona para botones y sticker -->
            <div class="column">

                <!-- Advertencia para mostrar que no siempre se  -->
                <div id="warning" class="ui green icon message attached">
                    <i class="lock icon"></i>
                    <div class="content">
                    <div class="header">
                        Estás seguro con nosotros
                    </div>
                    <p>
                        La imagen que uses no se almacenará en nuestros servidores, toda la aplicación se ejecutara en tu dispositivo.
                    </p></div>
                </div>

                <!-- Botón para subir imágenes -->
                <label for="img-subida" id="boton-sup" class="fluid ui labeled icon button">
                    <i class="upload icon"></i>
                    Pulsa aquí para subir tu imagen
                </label>
                <input type="file" id="img-subida" name="img-subida" onchange="mostrarImagen(this);" style="display:none">

                <!-- Grid con los stickers -->
                <h4 class="ui horizontal divider header">
                    Stickers
                </h4>

                <div id="grid-stickers">
                    <div class="row">
                        <a class="col-md-1 slider-control" href="#multi-item-example" role="button" data-slide="prev">
                            <div class="carousel-control-prev-icon" aria-hidden="true"></div>
                        </a>
                        
                        <div class="col-md-10">
                            <div id="multi-item-example" class="carousel slide" data-interval="false">

                                <div class="carousel-inner">
                                    <div class="carousel-item active">
                                        <div class="row">
                                            <div class="col-md-3 sticker-click" onclick="cambiarEstado(this,0);">
                                                <img src="stickers/merry.png" class="sticker-img" alt="">
                                            </div>
                                
                                            <div class="col-md-3 sticker-click" onclick="cambiarEstado(this,1);">
                                                <img src="stickers/gorro.png" class="sticker-img" alt="">
                                            </div>
                                
                                            <div class="col-md-3 sticker-click" onclick="cambiarEstado(this,2);">
                                                <img src="stickers/explosion.png" class="sticker-img" alt="">
                                            </div>
                                            
                                            <div class="col-md-3 sticker-click" onclick="cambiarEstado(this,3);">
                                                <img src="stickers/explosion2.png" class="sticker-img" alt="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="carousel-item">
                                        <div class="row">
                                            <div class="col-md-3 sticker-click" onclick="cambiarEstado(this,4);">
                                                <img src="stickers/corazon.png" class="sticker-img" alt="">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a class="col-md-1 slider-control" href="#multi-item-example" role="button" data-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        </a>
                    </div>
                </div>
                

                <!-- Slider para cambiar el tamaño del sticker -->
                <h4 class="ui horizontal divider header">
                    Tamaño
                  </h4>

                <div id="slider-div">
                    <input type="range" min="1" max="100" value="50" id="slider" onchange="cambiarTamano(this.value)" oninput="cambiarTamano(this.value)">
                </div>

                <!-- Botón para descargar imágenes -->
                <div class="fluid ui labeled icon button" onclick="descargar()">
                    <i class="download icon"></i>
                    Pulsa aquí para descargar la imagen
                </div>
            </div>

            <!-- Zona para canvas -->
            <div class="column">
                <canvas id="resultado">
                    Aquí verás tu imagen
                </canvas>
            </div>

            
        </div>

    <script>
    let stickers = [
    {
        url: 'stickers/merry.png',
        imagen: new Image(),
        defecto_x: 100,
        defecto_y: 100,
        x: 100,
        y: 100,
        pos_x: 0,
        pos_y: 0,
        estado: 0,
        activo: false,
        tamano: 1.0
    },
    {
        url: 'stickers/gorro.png',
        imagen: new Image(),
        defecto_x: 100,
        defecto_y: 100,
        x: 100,
        y: 100,
        pos_x: 0,
        pos_y: 0,
        estado: 0,
        activo: false,
        tamano: 1.0
    },
    {
        url: 'stickers/explosion.png',
        imagen: new Image(),
        defecto_x: 100,
        defecto_y: 100,
        x: 100,
        y: 100,
        pos_x: 0,
        pos_y: 0,
        estado: 0,
        activo: false,
        tamano: 1.0
    },
    {
        url: 'stickers/explosion2.png',
        imagen: new Image(),
        defecto_x: 100,
        defecto_y: 100,
        x: 100,
        y: 100,
        pos_x: 0,
        pos_y: 0,
        estado: 0,
        activo: false,
        tamano: 1.0
    },
    {
        url: 'stickers/corazon.png',
        imagen: new Image(),
        defecto_x: 100,
        defecto_y: 100,
        x: 100,
        y: 100,
        pos_x: 0,
        pos_y: 0,
        estado: 0,
        activo: false,
        tamano: 1.0
    }

]
    </script>
    
    <script>
    let canvas = null;
let context = null;

let fondo = {
    imagen: null,
    url: ''
}

let stickerActivo = null;

// Construye el canvas donde se mostrará la fotografía con los stickers
function construirCanvas(){
    canvas = document.getElementById('resultado');
    context = canvas.getContext('2d'); 

    // Crea las imágenes que se van mostrar
    fondo.imagen = new Image();
    // Cargas los stickers de forma asíncrona
    for(i=0; i<stickers.length; i++){
        stickers[i].imagen.src = stickers[i].url;
    }

    fondo.imagen.onload = function(){
        crearImagen();
    }

    fondo.imagen.src = fondo.url;
}

// Crea la imagen cada vez que cambia algo
// (Modificación de stickers, etc...)
function crearImagen(){

    // Ajusta la imagen al espacio establecido para el elemento canvas
    canvas.width = document.getElementById('resultado').offsetWidth; 
    canvas.height = canvas.width*fondo.imagen.height/fondo.imagen.width;

    // Dibuja toda la imagen
    context.clearRect(0, 0, canvas.width, canvas.height);
    context.globalAlpha = 1.0; 
    context.drawImage(fondo.imagen, 0, 0, canvas.width, canvas.height);
    context.globalAlpha = 1.0;

    stickers.filter(x => x.activo).map( y => { dibujarSticker(y); });   
}

function dibujarSticker( obj ){
    context.drawImage(obj.imagen, obj.pos_x, obj.pos_y, obj.x, obj.y);
    // console.log(obj)
}

// Toma la imagen subida y la dibuja
function mostrarImagen(input){
    // Se han introducido imágenes
    if (input.files && input.files[0]) {
        
        var reader = new FileReader();

        reader.onload = function (e) {
            // Se asocia a la primera imagen la url generada al subirla,
            // para que no pase por un servidor
            fondo.url = e.target.result;
            
            construirCanvas();
        }

        // Se lee el primer archivo introducido
        reader.readAsDataURL(input.files[0]);
    }
}

// Funcionalidad para mover un sticker a través de la imagen
let isDragging = true;

$("#resultado").mousedown(function(e){
    isDragging = true;
});

$(window).mouseup(function(){
    isDragging = false;
});

$("#resultado").mousemove(function(e) {
    if( isDragging == true && canvas)
    {
        var cRect = canvas.getBoundingClientRect();        // Gets CSS pos, and width/height
        var canvasX = e.clientX - cRect.left;  // Subtract the 'left' of the canvas 
        var canvasY = e.clientY - cRect.top;   // from the X/Y positions to make  
        stickers[stickerActivo].pos_x = canvasX;
        stickers[stickerActivo].pos_y = canvasY;
        crearImagen();
    }
});

// Descarga de la imagen
function descargar(){
    let link = document.createElement('a');
    link.download = 'osl_navidad.png';
    link.href = document.getElementById('resultado').toDataURL();
    link.click();
}

// Cambia el tamaño del sticker 
function cambiarTamano(valor){
    ratio = valor/50;
    stickers[stickerActivo].tamano = ratio;

    stickers[stickerActivo].x = stickers[stickerActivo].defecto_x*ratio;
    stickers[stickerActivo].y = stickers[stickerActivo].defecto_y*ratio;

    crearImagen();
}

function cambiarEstado( el, i ){

    // El sticker no se está mostrando
    if(stickers[i].estado == 0){
        el.style.backgroundColor = 'rgba(0, 255, 0, 0.2)';
        stickers[i].estado = 1;
        stickers[i].activo = true;

        crearImagen();
    }
    // El sticker se está mostrando
    else if(stickers[i].estado == 1){
        el.style.backgroundColor = 'rgba(255, 255, 0, 0.2)';
        stickers[i].estado = 2;

        if(stickerActivo != null){
            // Se quita el estado de seleccionado a otro sticker
            // si este se está mostrando
            if(stickers[stickerActivo].estado){
                stickers[stickerActivo].estado = 1;
                document.getElementsByClassName('sticker-click')[stickerActivo].style.backgroundColor = 'rgba(0, 255, 0, 0.2)';
            }
        }

        stickerActivo = i;
        // Cambia el valor del slider al correspondiente
        document.getElementById('slider').value = stickers[stickerActivo].tamano*50;
    }
    // El sticker está activo
    else{
        el.style.background = 'none';
        stickers[i].estado = 0;
        stickers[i].activo = false;
        crearImagen();
        stickerActivo = null;
    }

    
}
    </script>
</body>

</html>